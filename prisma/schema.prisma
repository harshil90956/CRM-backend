generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum AuthRole {
  SUPER_ADMIN
  ADMIN
  MANAGER
  AGENT
  CUSTOMER
}

enum LeadStatus {
  NEW
  CONTACTED
  FOLLOWUP
  QUALIFIED
  NEGOTIATION
  CONVERTED
  LOST
}

enum LeadPriority {
  High
  Medium
  Low
}

enum LeadSource {
  Website
  Facebook
  Referral
  Walk_in
  Google_Ads
  Instagram
  LinkedIn
  Conference
  Cold_Email
  Unit_Interest
}

enum ProjectMainType {
  Residential
  Commercial
  Industrial
}

enum ProjectStatus {
  Launching
  Active
  Completed
  On_Hold
  CLOSED
}

enum UnitStatus {
  AVAILABLE
  HOLD
  BOOKED
  SOLD
}

enum BookingStatus {
  HOLD_REQUESTED
  HOLD_CONFIRMED
  BOOKING_PENDING_APPROVAL
  BOOKING_CONFIRMED
  PAYMENT_PENDING
  BOOKED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  Pending
  Received
  Overdue
  Refunded
}

enum PaymentMethod {
  Bank_Transfer
  Cash
  Cheque
  Online
  UPI
  RTGS
  Card
  Net_Banking
}

enum ReviewStatus {
  pending
  approved
  rejected
}

enum ReviewType {
  property
  agent
  project
}

enum ReminderType {
  email
  sms
  whatsapp
}

enum ReminderStatus {
  SENT
  SCHEDULED
}

enum ActivityType {
  call
  email
  meeting
  note
}

model User {
  id       String   @id @default(uuid())
  name     String
  email    String   @unique
  phone    String?
  role     AuthRole
  isActive Boolean  @default(true)

  managerId String?
  manager   User?   @relation("UserManager", fields: [managerId], references: [id])
  agents    User[]  @relation("UserManager")

  tenantId String
  avatar   String?

  /**
   * ---------- LEADS ----------
   */
  assignedLeads Lead[] @relation("LeadAssignedTo")

  /**
   * ---------- ACTIVITIES ----------
   */
  activities Activity[] @relation("ActivityCreatedBy")

  /**
   * ---------- BOOKINGS ----------
   */
  customerBookings Booking[] @relation("BookingCustomer")
  agentBookings    Booking[] @relation("BookingAgent")
  managerBookings  Booking[] @relation("BookingManager")

  /**
   * ---------- PAYMENTS ----------
   */
  customerPayments Payment[] @relation("PaymentCustomer")

  /**
   * ---------- REVIEWS ----------
   */
  customerReviews Review[] @relation("ReviewCustomer")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("staff")
}

model Lead {
  id     String     @id @default(uuid())
  name   String
  email  String
  phone  String
  status LeadStatus
  source LeadSource

  priority LeadPriority?
  budget   String
  notes    String?

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  assignedToId String?
  assignedTo   User?   @relation("LeadAssignedTo", fields: [assignedToId], references: [id])

  tenantId String

  activities Activity[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("leads")
}

model Activity {
  id     String @id @default(uuid())
  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id])

  type    ActivityType
  message String

  createdBy String
  creator   User   @relation("ActivityCreatedBy", fields: [createdBy], references: [id])

  tenantId  String
  createdAt DateTime @default(now())
}

model EmailOtp {
  id        String   @id @default(uuid())
  email     String
  code      String
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Project {
  id          String          @id @default(uuid())
  name        String
  location    String
  mainType    ProjectMainType @default(Residential)
  priceRange  String          @default("")
  status      ProjectStatus   @default(Active)
  isClosed    Boolean         @default(false)
  description String?
  tenantId    String          @default("tenant_default")

  units Unit[]
  leads Lead[]

  createdAt DateTime  @default(now())
  bookings  Booking[]
}

model Unit {
  id        String     @id @default(uuid())
  unitNo    String
  projectId String
  project   Project    @relation(fields: [projectId], references: [id])
  status    UnitStatus
  price     Float

  bedrooms    Int?
  bathrooms   Int?
  floorNumber Int?
  towerName   String?

  tenantId String

  bookings Booking[]
  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Booking {
  id         String @id @default(uuid())
  customerId String
  customer   User   @relation("BookingCustomer", fields: [customerId], references: [id])

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  agentId String?
  agent   User?   @relation("BookingAgent", fields: [agentId], references: [id])

  managerId String?
  manager   User?   @relation("BookingManager", fields: [managerId], references: [id])

  totalPrice  Float
  tokenAmount Float
  status      BookingStatus

  tenantId String

  customerName  String?
  customerEmail String?
  customerPhone String?

  notes String?

  holdExpiresAt DateTime?

  approvedAt  DateTime?
  rejectedAt  DateTime?
  cancelledAt DateTime?

  managerNotes       String?
  cancellationReason String?

  payments Payment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id String @id @default(uuid())

  bookingId String?
  booking   Booking? @relation(fields: [bookingId], references: [id])

  customerId String
  customer   User   @relation("PaymentCustomer", fields: [customerId], references: [id])

  unitId String
  unit   Unit   @relation(fields: [unitId], references: [id])

  amount Float
  status PaymentStatus
  method PaymentMethod

  tenantId String

  paymentType String? // Token / Booking / Installment
  receiptNo   String?
  notes       String?
  paidAt      DateTime?
  refundRefId String?

  reminders PaymentReminder[]

  createdAt DateTime @default(now())
}

model PaymentReminder {
  id        String  @id @default(uuid())
  paymentId String
  payment   Payment @relation(fields: [paymentId], references: [id])

  type    ReminderType
  message String
  status  ReminderStatus

  scheduledAt DateTime
  sentAt      DateTime?

  tenantId String

  createdAt DateTime @default(now())
}

model Review {
  id       String     @id @default(uuid())
  type     ReviewType
  targetId String

  customerId String
  customer   User   @relation("ReviewCustomer", fields: [customerId], references: [id])

  rating  Int
  comment String
  images  Json?
  status  ReviewStatus

  tenantId  String
  createdAt DateTime @default(now())
}
